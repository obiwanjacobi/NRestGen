<#@ template debug="true" hostspecific="true" language="C#" inherits="NRestGen.TextTemplate.NRestGenTemplate" #>
<#@ output extension=".log" #>
<#@ assembly name="System.Core" #>
<#@ assembly name="System.Runtime" #>
<#@ assembly name="$(TargetDir)NRestGen.TextTemplate.dll" #>
<#@ assembly name="EnvDTE"#>
<#@ import namespace="System" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="NRestGen.TextTemplate" #>
/**********************************************
<#
    // >> Note that TextTemplates in Visual Studio are executed on .NET4!
    // >> Make sure the `TextTemplatingFileGenerator` is set as `Custom Tool` in this file's properties (F4).

    // change this if your file name is different.
    const string ResourceModelFileName = "ResourceModel.yaml";
    const string ResourceModelNamespace = "ResourceModel";
    const string ControllerNamespace = "Controllers";

  try {
    var dte = GetDevEnv(Host);
    Initialize(dte, Host, ResourceModelFileName);
    var path = BuildPath("ResourceModel.generated.cs", ResourceModelNamespace);
#>
Generating Resource Model classes: <#=path#>
<#
    /*
     *  Resource Model
     */

    MultiFile.StartNewFile(path);
#>
using NRestGen;
using System;
using System.Collections.Generic;

namespace <#=TargetNamespace#>.<#=ResourceModelNamespace#>
{
<# foreach (var entity in ResourceModel.Entities) { #>
    public partial class <#=entity.Name#> : Entity
    {
<# foreach(var prop in entity.Properties) { #>
        public <#=prop.Type#> <#=prop.Name#> { get; set; }
<# } // foreach-prop #>
    }

<# } // foreach-entity #>
}
<#
    MultiFile.EndBlock();
    path = BuildPath("ResourceModelBuilder.generated.cs", ResourceModelNamespace);
#>
Generate ResourceModelBuilder class: <#=path#>
<# 
    /*
     * Resource Model Builder
     */

    MultiFile.StartNewFile(path);
#>
using Microsoft.AspNet.OData.Builder;
using Microsoft.OData.Edm;

namespace <#=TargetNamespace#>.<#=ResourceModelNamespace#>
{
    public static partial class ResourceModelBuilder
    {
        public static IEdmModel Build()
        {
            var builder = new ODataConventionModelBuilder
            {
                Namespace = "<#=TargetNamespace#>.<#=ResourceModelNamespace#>"
            };
            builder.EnableLowerCamelCase();

<# foreach(var entity in ResourceModel.Entities) { #>
            builder.EntitySet<<#=entity.Name#>>("<#=entity.SetName#>");
<# } // foreach-entity #>

            return builder.GetEdmModel();
        }
    }
}
<# MultiFile.EndBlock(); #>
<# foreach (var entity in ResourceModel.Entities) { 
    path = BuildPath(entity.SetName + "Controller.generated.cs", ControllerNamespace);
#>
Generate <#=entity.Name#> Controller: <#=path#>
<# 
    /*
     *  Resource Controller
     */

    MultiFile.StartNewFile(path);
#>
<#  if (UseMediatr) { #>
using MediatR;
<#  } // if #>
<#  if (UseOData) { #>
using Microsoft.AspNet.OData;
using Microsoft.AspNet.OData.Query;
<#  } // if #>
using Microsoft.AspNetCore.Mvc;
using System;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using <#=TargetNamespace#>.<#=ResourceModelNamespace#>;

namespace <#=TargetNamespace#>.<#=ControllerNamespace#>
{
    /// <summary>
    /// Handles resource requests for the <#=entity.Name#> type.
    /// </summary>
    [ApiController]
    [ApiVersion("<#=ResourceModel.Settings.Api.Version#>")]
    //[Route("<#=ResourceModel.Settings.Api.BaseUrl#>/v{v:apiVersion}/[controller]")]
    [Route("<#=ResourceModel.Settings.Api.BaseUrl#>/[controller]")]
    public partial class <#=entity.SetName#>Controller : ControllerBase
    {
<#  if (UseMediatr) { #>
        private readonly IMediator _mediator;

        public <#=entity.SetName#>Controller(IMediator mediator)
        {
            _mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
        }
<#  } // if #>

        [HttpHeadGet("{id?}")]
<#  if (UseODataQueryable) { #>
        [EnableQuery]
<#  } 
    if (UseODataNotQueryable) { #>
        public async Task<IActionResult> Get(CancellationToken cancellationToken, ODataQueryOptions<<#=entity.Name#>> options, int? id = null)
<#  } else { #>
        public async Task<IActionResult> Get(CancellationToken cancellationToken, int? id = null)
<#  } // if #>
        {
<#  if (UseMediatr) { #>
            var request = new GetRequest<<#=entity.Name#>>(<#=UseODataNotQueryable ? "options, " : ""#>id.GetValueOrDefault())
            {
                Context = NewRequestContext()
            };
            var response = await _mediator.Send(request, cancellationToken);
<#  } else { #>
            var request = new Request<<#=entity.Name#>>(<#=UseODataNotQueryable ? "options, " : ""#>id.GetValueOrDefault())
            {
                Context = NewRequestContext()
            };
            var response = await Handle(request, cancellationToken);
<#  } // if-else UseMediatr #>
<#  if (UseODataQueryable) { #>
            return Ok(response.Results.AsQueryable());
<#  } else { #>
            return Ok(response);
<#  } // if #>
        }
<# 
    if (ResourceModel.Relations.ContainsKey(entity.Name)) { 
    var relations = ResourceModel.Relations[entity.Name];
    foreach(var relation in relations) {
#>
        
        [HttpHeadGet("{id}/<#=relation.SetName#>")]
<#  if (UseODataQueryable) { #>
        [EnableQuery]
<#  } 
    if (UseODataNotQueryable) { #>
        public async Task<IActionResult> Get<#=relation.SetName#>(CancellationToken cancellationToken, ODataQueryOptions<<#=relation.Name#>> options, int id)
<#  } else { #>
        public async Task<IActionResult> Get<#=relation.SetName#>(CancellationToken cancellationToken, int id)
<#  } // if #>
        {
<#    if (UseMediatr) { #>
            var request = new GetRequest<<#=relation.Name#>>(<#=UseODataNotQueryable ? "options" : ""#>)
            {
                ParentId = new ResourceIdentifier(typeof(<#=entity.Name#>), id),
                Context = NewRequestContext()
            };
            var response = await _mediator.Send(request, cancellationToken);
<#    } else { #>
            var request = new Request<<#=relation.Name#>>(<#=UseODataNotQueryable ? "options" : ""#>)
            {
                ParentId = new ResourceIdentifier(typeof(<#=entity.Name#>), id),
                Context = NewRequestContext()
            };
            var response = await Handle(request, cancellationToken);
<#    } // if-else #>
            return Ok(response.Results<#=UseODataQueryable ? ".AsQueryable()" : ""#>);
        }
<#  }} // foreach-relation/if #>

        private RequestContext NewRequestContext()
        {
            return new RequestContext(Request.Method, Request.Path, Request.QueryString.Value);
        }
    }
}
<# 
  MultiFile.EndBlock();
  } // foreach-entity
#>
<# if (!UseMediatr) { #>
<# foreach (var entity in ResourceModel.Entities) { 
    path = BuildPath(entity.SetName + "Controller.cs", ControllerNamespace);

    /*
     *  Resource Controller Implementation
     */

    MultiFile.StartNewFile(path, FileCreationMode.NotExists);
#>
using Microsoft.AspNetCore.Mvc;
using System;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using <#=TargetNamespace#>.<#=ResourceModelNamespace#>;

namespace <#=TargetNamespace#>.<#=ControllerNamespace#>
{
    /// <summary>
    /// Implementation of the <#=entity.Name#> controller handlers.
    /// </summary>
    public partial class <#=entity.SetName#>Controller : ControllerBase
    {
        private Task<Response<<#=entity.Name#>>> Handle(Request<<#=entity.Name#>> request, CancellationToken cancellationToken)
        {
            throw new NotImplementedException();
        }
<# 
    if (ResourceModel.Relations.ContainsKey(entity.Name)) { 
    var relations = ResourceModel.Relations[entity.Name];
    foreach(var relation in relations) {
#>
        
        private Task<Response<<#=relation.Name#>>> Handle(Request<<#=relation.Name#>> request, CancellationToken cancellationToken)
        {
            throw new NotImplementedException();
        }
<# }} // foreach/if #>
    }
}
<# 
  MultiFile.EndBlock();
  } // foreach-entity
#>
<# } // if-!UseMediatr #>
<# path = BuildPath("Request.generated.cs"); #>
Generate Request class: <#=path#>
<# 
    /*
     *  Request
     */

    MultiFile.StartNewFile(path);
#>
using System;
<# if (UseMediatr) { #>
using MediatR;
<# } // if #>
<# if (UseOData) { #>
using Microsoft.AspNet.OData.Query;
<# } // if #>

namespace <#=TargetNamespace#>
{
    public <#= UseMediatr ? "abstract" : ""#> partial class Request<ResourceT> : NRestGen.Request<ResourceT>
<# if (UseMediatr) { #>
            , IRequest<NRestGen.Response<ResourceT>>
<# } // if-UseMediatr #>
        where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public Request(ODataQueryOptions<ResourceT> options, int id = 0)
            : base(id)
        {
            Options = options ?? throw new ArgumentNullException(nameof(options));
        }

        public ODataQueryOptions<ResourceT> Options { get; private set; }
<# } else { #>
        public Request(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }
<# if (UseMediatr) { #>

    public partial class GetRequest<ResourceT> : Request<ResourceT> where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public GetRequest(ODataQueryOptions<ResourceT> options, int id = 0) : base(options, id) { }
<# } else { #>
        public GetRequest(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }

    public partial class PutRequest<ResourceT> : Request<ResourceT> where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public PutRequest(ODataQueryOptions<ResourceT> options, int id = 0) : base(options, id) { }
<# } else { #>
        public PutRequest(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }

    public partial class PatchRequest<ResourceT> : Request<ResourceT> where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public PatchRequest(ODataQueryOptions<ResourceT> options, int id = 0) : base(options, id) { }
<# } else { #>
        public PatchRequest(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }

    public partial class PostRequest<ResourceT> : Request<ResourceT> where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public PostRequest(ODataQueryOptions<ResourceT> options, int id = 0) : base(options, id) { }
<# } else { #>
        public PostRequest(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }

    public partial class DeleteRequest<ResourceT> : Request<ResourceT> where ResourceT : class
    {
<# if (UseODataNotQueryable) { #>
        public DeleteRequest(ODataQueryOptions<ResourceT> options, int id = 0) : base(options, id) { }
<# } else { #>
        public DeleteRequest(int id = 0) : base(id) { }
<# } // if-UseOData #>
    }
<# } // if-UseMediatr #>
}
<# 
  MultiFile.EndBlock();
#>
<# path = BuildPath("Startup.generated.cs"); #>
Generate StartupExtensions class: <#=path#>
<# 
    /*
     *  Startup Extensions
     */

    MultiFile.StartNewFile(path);
#>
<# if (UseMediatr) { #>
using MediatR;
<# } // if #>
<# if (UseOData) { #>
using Microsoft.AspNet.OData.Extensions;
using <#=TargetNamespace#>.<#=ResourceModelNamespace#>;
<# } // if #>
using Microsoft.AspNetCore.Routing;
using Microsoft.Extensions.DependencyInjection;

namespace <#=TargetNamespace#>
{
    public static class StartupExtensions
    {
        public static IServiceCollection AddNRestGen(this IServiceCollection services)
        {
<# if (UseMediatr &&
       ResourceModel.Settings.Mediatr.RegisterAssembly) { #>
            services.AddMediatR(typeof(Startup).Assembly);
<# } // if #>
<# if (UseOData) { #>
            services.AddOData();
<# } // if #>
            return services;
        }

        public static IEndpointRouteBuilder AddNRestGen(this IEndpointRouteBuilder endpoints)
        {
<# if (UseOData) { #>
            var resourceModel = ResourceModelBuilder.Build();
            endpoints.MapODataRoute("OData", "<#=ResourceModel.Settings.Api.BaseUrl#>", resourceModel);
            endpoints.EnableDependencyInjection();
            endpoints
<#  if (ResourceModel.Settings.Odata.Select) { #>
                .Select()
<#  } // if #>
<#  if (ResourceModel.Settings.Odata.Sort) { #>
                .OrderBy()
<#  } // if #>
<#  if (ResourceModel.Settings.Odata.Filter) { #>
                .Filter()
<#  } // if #>
<#  if (ResourceModel.Settings.Odata.Count) { #>
                .Count()
<#  } // if #>
<#  if (ResourceModel.Settings.Odata.Max > 0) { #>
                .MaxTop(<#=ResourceModel.Settings.Odata.Max#>)
<#  } // if #>
                ;
<# } // if #>
            return endpoints;
        }
    }
}
<# 
  MultiFile.EndBlock();
#>
<# Process(); #>
<# } catch(Exception e) { #>
Error:
<#=e.ToString()#>
<# 
  Error(e.ToString());
  } 
#>



Use the NuGet Package Manager to install the following packages:
----------------------------------------------------------------
<#
    if (UseMediatr) {
#>

Mediatr ----------------
- Mediatr (Jimmy Bogard) >= v8.1.0
- Mediatr.Extensions.Microsoft.DependencyInjection (Jimmy Bogard) >= v8.1.0
<#
    }
    if (UseOData) {
#>

OData ------------------
- Microsoft.AspNetCore.OData (Microsoft) >= v7.4.1
<#
    }
#>

*******************************************/
<#+ 
private bool UseMediatr
{
    get { return ResourceModel?.Settings?.Mediatr != null; }
}
private bool UseOData
{
    get { return ResourceModel?.Settings?.Odata != null; }
}
private bool UseODataQueryable
{
    get { return UseOData && ResourceModel.Settings.Odata.Queryable; }
}
private bool UseODataNotQueryable
{
    get { return UseOData && !ResourceModel.Settings.Odata.Queryable; }
}
#>